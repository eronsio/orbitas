<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>People Map â€” Full (Tiers, Geocoding, Search, Edit/Delete, Persistence)</title>
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <!-- PapaParse for CSV -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    :root { --bg:#0b1220; --panel:#0f1726; --card:#101826; --text:#e8eefc; --muted:#9fb0d0; --accent:#4f8cff; }
    *{ box-sizing: border-box; }
    html,body{ height:100%; margin:0; background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial; }
    .app{ display:grid; grid-template-rows: auto 1fr; height:100%; }
    header{ position:relative; z-index:1000; display:flex; align-items:center; gap:10px; padding:10px 14px; background: rgba(16,24,38,0.95); border-bottom:1px solid rgba(255,255,255,0.12); flex-wrap:wrap; }
    header h1{ margin:0; font-size:16px; font-weight:700; }
    .controls{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-left:auto; }
    .btn{ background:var(--card); color:var(--text); border:1px solid rgba(255,255,255,0.14); padding:8px 12px; border-radius:10px; cursor:pointer; font-size:13px; }
    .btn:hover{ border-color: rgba(255,255,255,0.25); }
    .file input{ display:none; }
    .toggle{ display:inline-flex; align-items:center; gap:6px; padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,0.14); background:var(--card); font-size:12px; cursor:pointer; }
    .toggle input{ accent-color: var(--accent); }
    .select, .search{ background:var(--card); color:var(--text); border:1px solid rgba(255,255,255,0.14); border-radius:10px; padding:8px 10px; font-size:13px; }
    .search{ width:220px; }
    #map{ height:100%; width:100%; }
    .debug{ position:absolute; top:64px; left:10px; background: rgba(16,24,38,0.92); color:var(--muted); padding:6px 8px; border-radius:10px; font-size:12px; border:1px solid rgba(255,255,255,0.12); z-index:999; }
    /* Side panel */
    .panel{ position:absolute; top:0; right:0; width:380px; max-width:92vw; height:100%; background:var(--panel); border-left:1px solid rgba(255,255,255,0.1); box-shadow:-8px 0 24px rgba(0,0,0,0.35); transform: translateX(100%); transition: transform .25s ease; display:flex; flex-direction:column; z-index:1200; }
    .panel.open{ transform: translateX(0); }
    .panel header{ display:flex; align-items:center; gap:10px; padding:12px 14px; border-bottom:1px solid rgba(255,255,255,0.08); }
    .panel header .title{ font-size:16px; font-weight:700; }
    .panel .content{ padding:14px; overflow:auto; display:flex; flex-direction:column; gap:12px; }
    .profile-card{ background:var(--card); border:1px solid rgba(255,255,255,0.12); border-radius:14px; padding:12px; display:grid; grid-template-columns:72px 1fr; gap:12px; align-items:center; }
    .profile-avatar{ width:72px; height:72px; border-radius:50%; background:#1c2842 center/cover no-repeat; border:2px solid #fff; display:block; }
    .profile-name{ font-size:18px; font-weight:700; }
    .profile-sub{ font-size:13px; color:var(--muted); }
    .profile-row{ display:grid; grid-template-columns:110px 1fr; gap:8px; font-size:13px; }
    /* Add modal */
    .modal{ position:fixed; inset:0; background: rgba(0,0,0,0.55); display:none; align-items:center; justify-content:center; padding:20px; z-index:1500; }
    .modal.open{ display:flex; }
    .dialog{ width:min(720px,96vw); max-height:90vh; overflow:auto; background:var(--panel); border:1px solid rgba(255,255,255,0.12); border-radius:14px; padding:16px; }
    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .grid .full{ grid-column:1 / -1; }
    input, textarea, select{ width:100%; padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,0.15); background:#0e1526; color:var(--text); font-size:13px; }
    textarea{ min-height:72px; }
    /* Custom marker */
    .person-marker{ display:flex; flex-direction:column; align-items:center; transform: translateY(-12px); transition: transform .1s ease; }
    .avatar{ width:36px; height:36px; border-radius:50%; background-size:cover; background-position:center; box-shadow:0 2px 8px rgba(0,0,0,0.45); border:2px solid #fff; }
    .avatar.initials{ display:flex; align-items:center; justify-content:center; background:var(--accent); color:#fff; font-weight:700; }
    .label{ margin-top:4px; padding:2px 6px; font-size:12px; line-height:1; background: rgba(16,24,38,0.92); color:#eaf1ff; border:1px solid rgba(255,255,255,0.14); border-radius:8px; white-space:nowrap; box-shadow:0 1px 4px rgba(0,0,0,0.35); }
    /* Tier styling */
    .person-marker.tier-1{ transform: translateY(-12px) scale(1.12); }
    .person-marker.tier-2{ transform: translateY(-12px) scale(1.0); }
    .person-marker.tier-3{ transform: translateY(-12px) scale(0.9); opacity:0.95; }
    .person-marker.tier-1 .avatar{ border-color:#ffd54f; box-shadow:0 0 0 2px rgba(255,213,79,.32), 0 2px 8px rgba(0,0,0,.45); }
    .person-marker.tier-2 .avatar{ border-color:#64b5f6; }
    .person-marker.tier-3 .avatar{ border-color:#9e9e9e; }
    /* FAB */
    .fab{ position: fixed; bottom: 20px; right: 20px; width: 52px; height: 52px; border-radius: 50%; background: var(--accent); color: white; display: grid; place-items: center; font-size: 28px; border: none; cursor: pointer; box-shadow: 0 10px 22px rgba(0,0,0,0.35); z-index: 1100; }
    /* Search results */
    .results{
      position:absolute; top:64px; right:10px; z-index:1000;
      max-height:50vh; overflow:auto; min-width:260px;
      background:rgba(16,24,38,0.96); border:1px solid rgba(255,255,255,0.14);
      border-radius:10px; padding:6px; display:none;
    }
    .results.open{ display:block; }
    .result-item{
      padding:8px 10px; border-radius:8px; cursor:pointer; font-size:13px;
    }
    .result-item:hover{ background:rgba(255,255,255,0.06); }
    .result-sub{ color:#9fb0d0; font-size:12px; }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>People Map</h1>
      <div class="controls">
        <label class="btn file">ðŸ“„ Load CSV
          <input id="fileInput" type="file" accept=".csv" />
        </label>
        <button id="demoBtn" class="btn">Load Demo</button>
        <button id="fitBtn" class="btn">Fit to Pins</button>
        <button id="addBtn" class="btn">+ Add Person</button>
        <label class="toggle"><input type="checkbox" id="tgGeocode"> Geocode addresses (CSV)</label>
        <label class="toggle"><input type="checkbox" id="tgIG"> Instagram avatars</label>
        <select id="tierFilter" class="select" title="Filter by closeness">
          <option value="">Tier: All</option>
          <option value="1">Tier 1</option>
          <option value="2">Tier 2</option>
          <option value="3">Tier 3</option>
        </select>
        <input id="q" class="search" placeholder="Search name/tags/city/country" />
        <!-- Persistence controls -->
        <button id="saveCsv" class="btn">Export CSV</button>
        <button id="saveJson" class="btn">Export JSON</button>
        <label class="btn file">Import JSON
          <input id="importJson" type="file" accept=".json" />
        </label>
      </div>
    </header>
    <div style="position:relative; height:100%;">
      <div id="map"></div>
      <div id="searchResults" class="results"></div>
      <div class="debug" id="debug">Add via form (address-only works) or load CSV. Search + Tier filter available. Autosaves locally.</div>
      <div class="panel" id="panel">
        <header>
          <div class="title" id="panelTitle">Profile</div>
          <div style="margin-left:auto"></div>
          <button class="btn" id="editPerson">Edit</button>
          <button class="btn" id="deletePerson">Delete</button>
          <button class="btn" id="closePanel">Close</button>
        </header>
        <div class="content">
          <div class="profile-card">
            <div class="profile-avatar" id="pAvatar"></div>
            <div>
              <div class="profile-name" id="pName">â€”</div>
              <div class="profile-sub" id="pSubtitle">â€”</div>
            </div>
          </div>
          <div class="profile-row"><div>Tier</div><div id="pTier">â€”</div></div>
          <div class="profile-row"><div>Occupation</div><div id="pJob">â€”</div></div>
          <div class="profile-row"><div>Location</div><div id="pLoc">â€”</div></div>
          <div class="profile-row"><div>Coordinates</div><div id="pCoords">â€”</div></div>
          <div class="profile-row"><div>Instagram</div><div id="pIg">â€”</div></div>
          <div class="profile-row"><div>Tags</div><div id="pTags">â€”</div></div>
          <div class="profile-row"><div>Notes</div><div id="pNotes">â€”</div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Person Modal -->
  <div class="modal" id="modal">
    <div class="dialog">
      <h2 id="formTitle">Add Person</h2>
      <form id="addForm" class="grid">
        <label class="full">Name
          <input name="name" required placeholder="Jane Doe" />
        </label>
        <label>Occupation
          <input name="occupation" placeholder="Designer" />
        </label>
        <label>Tier (1â€“3)
          <select name="tier">
            <option value="">â€”</option>
            <option>1</option>
            <option>2</option>
            <option>3</option>
          </select>
        </label>
        <label>Tags (comma-separated)
          <input name="tags" placeholder="friend,europe,design" />
        </label>
        <label>Instagram (handle or @)
          <input name="instagram" placeholder="@janedoe" />
        </label>
        <label>Photo URL <small>(overrides Instagram)</small>
          <input name="photo" placeholder="https://...jpg" />
        </label>
        <label class="full">Full Address
          <input name="address" placeholder="Optional if you enter City/Country" />
        </label>
        <label>City
          <input name="city" placeholder="e.g., Madrid" />
        </label>
        <label>Region/State
          <input name="region" placeholder="e.g., Community of Madrid" />
        </label>
        <label>Country
          <input name="country" placeholder="e.g., Spain" />
        </label>
        <label>Latitude
          <input name="lat" placeholder="(leave empty to auto-place)" />
        </label>
        <label>Longitude
          <input name="lng" placeholder="(leave empty to auto-place)" />
        </label>
        <label class="full" style="display:flex; align-items:center; gap:8px;">
          <input type="checkbox" name="formGeocode" checked />
          Place by address/city (no coords)
        </label>
        <label class="full">Notes
          <textarea name="notes" placeholder="How you met, last contacted, etc."></textarea>
        </label>
        <div class="full" style="display:flex; gap:8px; justify-content:flex-end; margin-top:6px;">
          <button type="button" class="btn" id="cancelAdd">Cancel</button>
          <button type="submit" class="btn" id="saveBtn">Save</button>
        </div>
      </form>
      <div id="formStatus" style="margin-top:8px; font-size:12px; color:var(--muted);"></div>
    </div>
  </div>
  <button class="fab" id="addFab">ï¼‹</button>

  <script>
    // ---------- UTILITIES ----------
    const $ = (sel) => document.querySelector(sel);
    const debug = $('#debug');
    function setDebug(msg){ if (debug) debug.innerHTML = msg; }
    function initialsFromName(name){ if (!name) return '?'; const parts = name.trim().split(/\s+/).slice(0,2); return parts.map(p => p[0]?.toUpperCase() || '').join('') || '?'; }
    function normalizeNumber(v){ if (v == null) return NaN; if (typeof v === 'number') return v; let s = String(v).trim(); if (!s) return NaN; if (s.includes(',') && !s.includes('.')) s = s.replace(',', '.'); s = s.replace(/\s+/g,''); const n = parseFloat(s); return Number.isFinite(n) ? n : NaN; }
    function pick(obj, keys){ for (const k of keys){ if (k in obj && obj[k] !== '') return obj[k]; } return ''; }
    function instagramAvatar(handle){ if (!handle) return ''; const h = String(handle).replace(/^@/,'').trim(); if (!h) return ''; return `https://unavatar.io/instagram/${encodeURIComponent(h)}`; }
    function computePhoto({ photo, instagram, igEnabled }){ if (photo && /^https?:\/\//i.test(photo)) return photo; if (igEnabled && instagram) return instagramAvatar(instagram); return ''; }
    function tierClass(t){ return t===1?'tier-1': t===2?'tier-2':'tier-3'; }
    function makePersonIcon({ name, photoUrl, tier }){ 
      const safeName = name || 'Unknown'; 
      const hasPhoto = photoUrl && /^https?:\/\//i.test(photoUrl); 
      const html = `
        <div class="person-marker ${tierClass(tier)}">
          <div class="avatar ${hasPhoto ? '' : 'initials'}" style="${hasPhoto ? `background-image:url('${photoUrl.replace(/'/g, "%27")}')` : ''}">${hasPhoto ? '' : initialsFromName(safeName)}</div>
          <div class="label">${safeName.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>
        </div>`;
      return L.divIcon({ html, className: 'person-divicon', iconSize: [60,60], iconAnchor: [30,40], popupAnchor: [0,-40] });
    }

    // Geocoder (OSM Nominatim + cache)
    async function geocodeAddress(addr){
      if (!addr) return null;
      const key = 'geo:'+addr;
      const cached = localStorage.getItem(key);
      if (cached){ try { return JSON.parse(cached); } catch(e){} }
      await new Promise(r => setTimeout(r, 550));
      try{
        const res = await fetch('https://nominatim.openstreetmap.org/search?format=json&q='+encodeURIComponent(addr), { headers:{'Accept':'application/json'} });
        const js = await res.json();
        if (Array.isArray(js) && js.length){ const out = { lat: parseFloat(js[0].lat), lng: parseFloat(js[0].lon) }; localStorage.setItem(key, JSON.stringify(out)); return out; }
      }catch(e){ console.warn('Geocode failed', e); }
      return null;
    }
    function buildAddress({address, city, region, country}){
      return [address, city, region, country].filter(Boolean).join(', ');
    }

    // ---------- MAP INIT (no wrap; no repeating world) ----------
    const map = L.map('map', {
      zoomControl: true,
      minZoom: 2,
      maxZoom: 19,
      worldCopyJump: false
    }).setView([20, 0], 2);

    const OSM = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors',
      noWrap: true
    }).addTo(map);

    const southWest = L.latLng(-85, -180), northEast = L.latLng(85, 180);
    const boundsWorld = L.latLngBounds(southWest, northEast);
    map.setMaxBounds(boundsWorld);
    map.on('drag', function(){ map.panInsideBounds(boundsWorld, { animate:false }); });

    const cluster = L.markerClusterGroup({ showCoverageOnHover: false, disableClusteringAtZoom: 12 });
    map.addLayer(cluster);

    // ---------- STATE & PERSISTENCE ----------
    const STORAGE_KEY = 'peopleMapDataV2';
    let people = [];
    const markerById = new Map();
    let filterTier = '';    // '', '1','2','3'
    let filterQuery = '';
    let currentPerson = null;
    let isEditing = false;

    function saveToLocal() {
      try { localStorage.setItem(STORAGE_KEY, JSON.stringify(people)); }
      catch (e) { console.warn('Local save failed', e); }
    }
    function loadFromLocal() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return false;
        const arr = JSON.parse(raw);
        if (!Array.isArray(arr)) return false;
        people = arr.map(p => ({ id: p.id || (crypto?.randomUUID?.()||String(Math.random())), ...p }));
        return true;
      } catch (e) { console.warn('Local load failed', e); return false; }
    }
    function toCsvRow(vals){ return vals.map(v=>{
      const s = (v==null?'':String(v));
      return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
    }).join(','); }
    function exportCSV() {
      const header = ['Name','Latitude','Longitude','Photo URL','Occupation','Instagram','Tags','Notes','Full Address','City','Region/State','Country','Tier'];
      const rows = people.map(p => [
        p.name, p.lat, p.lng, p.photo||'', p.occupation||'', p.instagram||'',
        p.tags||'', p.notes||'', p.address||'', p.city||'', p.region||'',
        p.country||'', p.tier||''
      ]);
      const csv = [toCsvRow(header), ...rows.map(toCsvRow)].join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'people-export.csv';
      a.click();
      URL.revokeObjectURL(a.href);
    }
    function exportJSON() {
      const blob = new Blob([JSON.stringify(people, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'people-export.json';
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // ---------- FILTERS & SEARCH ----------
    function personToLocationString(p){ return [p.address, p.city, p.region, p.country].filter(Boolean).join(', '); }
    function matchesFilter(p){
      if (filterTier){
        const t = parseInt(filterTier); if ((p.tier||0)!==t) return false;
      }
      if (filterQuery){
        const q = filterQuery.toLowerCase();
        const blob = [p.name||'', p.tags||'', p.city||'', p.region||'', p.country||''].join(' ').toLowerCase();
        if (!blob.includes(q)) return false;
      }
      return true;
    }

    const resultsBox = $('#searchResults');
    function indexableText(p){
      return [(p.name||''),(p.tags||''),(p.city||''),(p.region||''),(p.country||'')].join(' ').toLowerCase();
    }
    function runSearch(q){
      const needle = (q||'').trim().toLowerCase();
      if (!needle){ resultsBox.classList.remove('open'); resultsBox.innerHTML=''; return; }
      const matches = people
        .filter(p => Number.isFinite(p.lat) && Number.isFinite(p.lng))
        .filter(p => indexableText(p).includes(needle))
        .slice(0, 30);

      if (!matches.length){ resultsBox.classList.remove('open'); resultsBox.innerHTML=''; return; }

      resultsBox.innerHTML = matches.map(p=>`
        <div class="result-item" data-id="${p.id}">
          <div><strong>${p.name || 'â€”'}</strong> ${p.tier?`<span class="result-sub">â€¢ Tier ${p.tier}</span>`:''}</div>
          <div class="result-sub">${[p.city,p.country].filter(Boolean).join(', ') || 'â€”'}${p.tags?` â€¢ ${p.tags}`:''}</div>
        </div>
      `).join('');
      resultsBox.classList.add('open');

      resultsBox.querySelectorAll('.result-item').forEach(el=>{
        el.addEventListener('click', ()=>{
          const id = el.getAttribute('data-id');
          const p = people.find(x=>x.id===id);
          if (!p) return;
          map.flyTo([p.lat, p.lng], Math.max(6, map.getZoom()));
          openPanel(p);
          resultsBox.classList.remove('open');
        });
      });
    }

    // ---------- PANEL ----------
    function openPanel(p){
      currentPerson = p;
      $('#panel').classList.add('open');
      const igEnabled = $('#tgIG').checked;
      const avatar = $('#pAvatar'); const photo = computePhoto({ photo: p.photo, instagram: p.instagram, igEnabled });
      if (photo){ avatar.style.backgroundImage = `url('${photo}')`; avatar.textContent = ''; }
      else { avatar.style.backgroundImage = 'none'; avatar.textContent = initialsFromName(p.name); avatar.style.display='flex'; avatar.style.alignItems='center'; avatar.style.justifyContent='center'; avatar.style.color='#fff'; avatar.style.fontWeight='700'; }
      $('#panelTitle').textContent = p.name || 'Profile';
      $('#pName').textContent = p.name || 'â€”';
      $('#pSubtitle').textContent = p.tags || '';
      $('#pTier').textContent = p.tier || 'â€”';
      $('#pJob').textContent = p.occupation || 'â€”';
      $('#pLoc').textContent = personToLocationString(p) || 'â€”';
      $('#pCoords').textContent = (Number.isFinite(p.lat) && Number.isFinite(p.lng)) ? `${p.lat.toFixed(5)}, ${p.lng.toFixed(5)}` : 'â€”';
      $('#pIg').innerHTML = p.instagram ? `<a href="https://instagram.com/${String(p.instagram).replace(/^@/,'')}" target="_blank" style="color:#9fc0ff">@${String(p.instagram).replace(/^@/,'')}</a>` : 'â€”';
      $('#pTags').textContent = p.tags || 'â€”';
      $('#pNotes').textContent = p.notes || 'â€”';
    }
    $('#closePanel').addEventListener('click', ()=> $('#panel').classList.remove('open'));

    // ---------- MARKERS ----------
    function addMarkerForPerson(p){
      const igEnabled = $('#tgIG').checked;
      const photo = computePhoto({ photo: p.photo, instagram: p.instagram, igEnabled });
      const marker = L.marker([p.lat, p.lng], { icon: makePersonIcon({ name: p.name, photoUrl: photo, tier: p.tier||3 }) });
      marker.on('click', () => openPanel(p));
      cluster.addLayer(marker);
      markerById.set(p.id, marker);
    }
    function refreshMarkers(){
      cluster.clearLayers();
      markerById.clear();
      const bounds = [];
      let count = 0;
      for (const p of people){
        if (!Number.isFinite(p.lat) || !Number.isFinite(p.lng)) continue;
        if (!matchesFilter(p)) continue;
        addMarkerForPerson(p);
        bounds.push([p.lat, p.lng]);
        count++;
      }
      if (bounds.length) map.fitBounds(bounds, { padding: [40, 40] });
      setDebug(count ? `Showing <b>${count}</b> pins${filterTier? ' (Tier '+filterTier+')':''}${filterQuery? ' â€¢ filter: '+filterQuery:''}.` : 'No pins match your filters.');
    }

    // ---------- EDIT / DELETE ----------
    function fillFormFromPerson(p){
      const form = $('#addForm');
      form.reset();
      form.querySelector('[name="name"]').value = p.name || '';
      form.querySelector('[name="occupation"]').value = p.occupation || '';
      form.querySelector('[name="tier"]').value = p.tier || '';
      form.querySelector('[name="tags"]').value = p.tags || '';
      form.querySelector('[name="instagram"]').value = p.instagram || '';
      form.querySelector('[name="photo"]').value = p.photo || '';
      form.querySelector('[name="address"]').value = p.address || '';
      form.querySelector('[name="city"]').value = p.city || '';
      form.querySelector('[name="region"]').value = p.region || '';
      form.querySelector('[name="country"]').value = p.country || '';
      form.querySelector('[name="lat"]').value = Number.isFinite(p.lat)? p.lat : '';
      form.querySelector('[name="lng"]').value = Number.isFinite(p.lng)? p.lng : '';
      form.querySelector('[name="notes"]').value = p.notes || '';
      form.querySelector('[name="formGeocode"]').checked = true;
    }
    function getMarkerById(id){ return markerById.get(id) || null; }

    $('#editPerson').addEventListener('click', ()=>{
      if (!currentPerson) return;
      isEditing = true;
      $('#formTitle').textContent = 'Edit Person';
      fillFormFromPerson(currentPerson);
      $('#modal').classList.add('open');
    });
    $('#deletePerson').addEventListener('click', ()=>{
      if (!currentPerson) return;
      const p = currentPerson;
      if (!confirm(`Delete ${p.name}? This canâ€™t be undone.`)) return;

      people = people.filter(x => x.id !== p.id);
      const marker = markerById.get(p.id);
      if (marker){ cluster.removeLayer(marker); markerById.delete(p.id); }

      $('#panel').classList.remove('open');
      currentPerson = null;
      saveToLocal();
      setDebug('Deleted.');
    });

    // ---------- STARTUP: restore data ----------
    if (loadFromLocal()) { refreshMarkers(); setDebug('Restored from local data.'); }

    // ---------- CSV IMPORT ----------
    $('#fileInput').addEventListener('change', (e)=>{
      const f = e.target.files?.[0]; if (!f) return;
      Papa.parse(f, {
        header: true, skipEmptyLines: true,
        complete: async (res)=>{
          const rows = res.data; people = [];
          for (const r of rows){
            const name = pick(r, ['Name','name']); if (!name) continue;
            const photo = pick(r, ['Photo URL','Photo','photo']);
            const occupation = pick(r, ['Occupation','Job','job']);
            const instagram = pick(r, ['Instagram','IG','instagram']);
            const tags = pick(r, ['Tags','tags']);
            const notes = pick(r, ['Notes','notes']);
            const city = pick(r, ['City','city']);
            const region = pick(r, ['Region/State','Region','State','region','state']);
            const country = pick(r, ['Country','country']);
            const address = pick(r, ['Full Address (optional)','Full Address','Address','address']);
            let tier = parseInt(pick(r, ['Tier','tier'])) || 0; if (tier<1 || tier>3) tier = 3;
            let lat = normalizeNumber(pick(r, ['Latitude','latitude','lat']));
            let lng = normalizeNumber(pick(r, ['Longitude','longitude','lng','lon']));
            if ((!Number.isFinite(lat) || !Number.isFinite(lng)) && $('#tgGeocode').checked){
              const query = buildAddress({address, city, region, country});
              if (query){ const pt = await geocodeAddress(query); if (pt){ lat = pt.lat; lng = pt.lng; } }
            }
            people.push({ id: crypto.randomUUID(), name, photo, occupation, instagram, tags, notes, city, region, country, address, lat, lng, tier });
          }
          refreshMarkers();
          saveToLocal();
          setDebug(`Imported ${people.length} people from CSV (saved locally).`);
        },
        error: (err)=> alert('CSV parse error: ' + err.message)
      });
    });

    // ---------- DEMO ----------
    $('#demoBtn').addEventListener('click', ()=>{
      people = [
        { id: crypto.randomUUID(), name:'Alex Chen', city:'Lisbon', country:'Portugal', lat:38.7223, lng:-9.1393, occupation:'Product Designer', tags:'friend,design', instagram:'alexchen', notes:'', tier:1 },
        { id: crypto.randomUUID(), name:'MarÃ­a GÃ³mez', city:'Madrid', country:'Spain', lat:40.4168, lng:-3.7038, occupation:'Data Analyst', tags:'data,spain', instagram:'', notes:'', tier:2 },
        { id: crypto.randomUUID(), name:'Samir Patel', city:'New York', country:'USA', lat:40.7128, lng:-74.0060, occupation:'Software Engineer', tags:'engineering,usa', instagram:'samir.codes', notes:'', tier:3 },
        { id: crypto.randomUUID(), name:'Noa Levi', city:'Tel Aviv', country:'Israel', lat:32.0853, lng:34.7818, occupation:'Photographer', tags:'photo', instagram:'noa.levi', photo:'https://images.unsplash.com/photo-1544723795-3fb6469f5b39?w=300', tier:1 }
      ];
      refreshMarkers(); saveToLocal();
    });

    // ---------- FIT ----------
    $('#fitBtn').addEventListener('click', ()=>{
      const layers = cluster.getLayers();
      if (layers.length){
        const bounds = L.latLngBounds(layers.map(m => m.getLatLng()));
        map.fitBounds(bounds, { padding: [40, 40] });
      }
    });

    // ---------- ADD / EDIT FORM ----------
    const modal = $('#modal'); const openAdd=()=>{ $('#formTitle').textContent='Add Person'; isEditing=false; modal.classList.add('open'); }; const closeAdd=()=>modal.classList.remove('open');
    $('#addBtn').addEventListener('click', openAdd); $('#addFab').addEventListener('click', openAdd); $('#cancelAdd').addEventListener('click', ()=>{ isEditing=false; closeAdd(); });

    $('#addForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const fd = new FormData(e.target);
      const status = $('#formStatus'); status.textContent = '';

      let name = String(fd.get('name')||'').trim(); if (!name){ alert('Name is required'); return; }
      let occupation = String(fd.get('occupation')||'').trim();
      let tags = String(fd.get('tags')||'').trim();
      let instagram = String(fd.get('instagram')||'').trim();
      let photo = String(fd.get('photo')||'').trim();
      let address = String(fd.get('address')||'').trim();
      let city = String(fd.get('city')||'').trim();
      let region = String(fd.get('region')||'').trim();
      let country = String(fd.get('country')||'').trim();
      let tier = parseInt(String(fd.get('tier')||'').trim()) || 3; if (tier<1||tier>3) tier=3;
      let lat = normalizeNumber(fd.get('lat'));
      let lng = normalizeNumber(fd.get('lng'));
      let notes = String(fd.get('notes')||'').trim();
      const wantFormGeocode = fd.get('formGeocode') !== null;

      if ((!Number.isFinite(lat) || !Number.isFinite(lng)) && wantFormGeocode){
        const query = buildAddress({address, city, region, country});
        if (!query){ alert('Please provide at least a City or Country, or enter coordinates.'); return; }
        status.textContent = 'Finding coordinates for '+query+'â€¦';
        const pt = await geocodeAddress(query);
        if (pt){ lat = pt.lat; lng = pt.lng; status.textContent = ''; }
        else { status.textContent = ''; alert('Could not locate that place. Please try a fuller address or paste coordinates.'); return; }
      }
      if (!Number.isFinite(lat) || !Number.isFinite(lng)){ alert('Please provide Lat/Lng or enable â€œPlace by address/cityâ€.'); return; }

      if (!isEditing){
        // ADD
        const p = { id: crypto.randomUUID(), name, occupation, tags, instagram, photo, address, city, region, country, lat, lng, notes, tier };
        people.push(p);
        const igEnabled = $('#tgIG').checked;
        const mPhoto = computePhoto({ photo: p.photo, instagram: p.instagram, igEnabled });
        const marker = L.marker([p.lat, p.lng], { icon: makePersonIcon({ name: p.name, photoUrl: mPhoto, tier: p.tier }) });
        marker.on('click', () => openPanel(p)); cluster.addLayer(marker);
        markerById.set(p.id, marker);
        setDebug(`Added <b>${p.name}</b>.`);
      } else {
        // EDIT
        const p = currentPerson;
        Object.assign(p, { name, occupation, tags, instagram, photo, address, city, region, country, lat, lng, notes, tier });
        const igEnabled = $('#tgIG').checked;
        const mPhoto = computePhoto({ photo: p.photo, instagram: p.instagram, igEnabled });
        const marker = markerById.get(p.id);
        if (marker){
          marker.setLatLng([p.lat, p.lng]);
          marker.setIcon( makePersonIcon({ name: p.name, photoUrl: mPhoto, tier: p.tier }) );
        } else {
          const m2 = L.marker([p.lat, p.lng], { icon: makePersonIcon({ name: p.name, photoUrl: mPhoto, tier: p.tier })});
          m2.on('click', () => openPanel(p));
          cluster.addLayer(m2);
          markerById.set(p.id, m2);
        }
        openPanel(p);
        setDebug(`Updated <b>${p.name}</b>.`);
      }

      closeAdd(); e.target.reset(); isEditing = false; saveToLocal();
    });

    // ---------- TOGGLES & FILTERS & SEARCH ----------
    $('#tgIG').addEventListener('change', ()=>{ refreshMarkers(); saveToLocal(); });
    $('#tierFilter').addEventListener('change', (e)=>{ filterTier = e.target.value; refreshMarkers(); });
    $('#q').addEventListener('input', (e)=>{ filterQuery = e.target.value.trim(); refreshMarkers(); runSearch(e.target.value); });
    $('#q').addEventListener('keydown',(e)=>{ if (e.key==='Escape'){ resultsBox.classList.remove('open'); resultsBox.innerHTML=''; } });

    // ---------- EXPORTS / IMPORTS ----------
    $('#saveCsv').addEventListener('click', exportCSV);
    $('#saveJson').addEventListener('click', exportJSON);
    $('#importJson').addEventListener('change', (e)=>{
      const f = e.target.files?.[0]; if (!f) return;
      const rd = new FileReader();
      rd.onload = ()=>{
        try{
          const arr = JSON.parse(rd.result);
          if (!Array.isArray(arr)) { alert('JSON must be an array.'); return; }
          people = arr.map(p => ({ id: p.id || (crypto?.randomUUID?.()||String(Math.random())), ...p }));
          refreshMarkers(); saveToLocal();
          setDebug(`Imported ${people.length} people from JSON (saved locally).`);
        }catch(err){ alert('Invalid JSON'); }
      };
      rd.readAsText(f);
    });
  </script>
</body>
</html>
